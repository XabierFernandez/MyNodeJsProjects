<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>MQTT Client Dashboard</title>

        <!-- Favicon -->
        <link
            rel="icon"
            href="/n3-favicon-kb-32x32px.svg"
            type="image/svg+xml"
        />

        <!-- Bootstrap CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/style.css" />
    </head>
    <body class="bg-light">
        <!-- Navbar with Logotype -->
        <nav class="navbar navbar-dark bg-dark">
            <div class="container-fluid">
                <a class="navbar-brand d-flex align-items-center" href="#">
                    <img
                        src="/Logotype-orange-n3uron.svg"
                        alt="Logotype"
                        class="me-2"
                        style="height: 40px"
                    />
                    MQTT Dashboard
                </a>
            </div>
        </nav>

        <!-- Main Container with extra padding -->
        <div class="container-fluid px-4 py-4">
            <div class="row gx-5">
                <!-- Left Column: narrower (4 of 12 columns on sm+ screens) -->
                <!-- Left Column: narrower (4 of 12 columns on sm+ screens) -->
                <div class="col-12 col-sm-4 col-lg-3 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h4 class="card-title mb-3">MQTT Connection</h4>
                            <form>
                                <div class="mb-3">
                                    <label for="brokerUrl" class="form-label"
                                        >Broker URL</label
                                    >
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="brokerUrl"
                                        placeholder="e.g. datasim.n3uron.com"
                                        value="datasim.n3uron.com"
                                    />
                                </div>
                                <div class="mb-3">
                                    <label for="brokerPort" class="form-label"
                                        >Broker Port</label
                                    >
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="brokerPort"
                                        placeholder="e.g. 1883"
                                        value="1883"
                                    />
                                </div>
                                <div class="mb-3">
                                    <label for="topic" class="form-label"
                                        >Topic</label
                                    >
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="topic"
                                        placeholder="e.g. test/topic"
                                        value="test/topic"
                                    />
                                </div>
                                <div class="mb-3">
                                    <label for="username" class="form-label"
                                        >Username</label
                                    >
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="username"
                                        placeholder="Optional"
                                    />
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label"
                                        >Password</label
                                    >
                                    <input
                                        type="password"
                                        class="form-control"
                                        id="password"
                                        placeholder="Optional"
                                    />
                                </div>
                                <div class="mb-3">
                                    <label for="qos" class="form-label"
                                        >QoS</label
                                    >
                                    <select class="form-select" id="qos">
                                        <option value="0" selected>0</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                    </select>
                                </div>
                                <div class="d-flex gap-2">
                                    <button
                                        type="button"
                                        id="connectBtn"
                                        class="btn btn-primary"
                                    >
                                        Connect
                                    </button>
                                    <button
                                        type="button"
                                        id="disconnectBtn"
                                        class="btn btn-secondary"
                                    >
                                        Disconnect
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Right Column: wider (8 of 12 columns on sm+ screens) -->
                <div class="col-12 col-sm-8 col-lg-9">
                    <div class="card shadow-sm">
                        <div class="card-body d-flex flex-column">
                            <h4 class="card-title mb-3">
                                Incoming MQTT Messages
                            </h4>
                            <!-- Control Buttons -->
                            <div class="mb-3 d-flex gap-2 flex-wrap">
                                <button
                                    type="button"
                                    id="clearBtn"
                                    class="btn btn-warning"
                                >
                                    Clear Output
                                </button>
                                <button
                                    type="button"
                                    id="downloadBtn"
                                    class="btn btn-success"
                                >
                                    Download Output
                                </button>
                                <button
                                    type="button"
                                    id="copyBtn"
                                    class="btn btn-info"
                                >
                                    Copy to Clipboard
                                </button>
                            </div>
                            <!-- Messages Output Area (flex-grow for vertical fill) -->
                            <div
                                id="messages"
                                class="message-output border rounded p-3 flex-grow-1"
                            ></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bootstrap JS Bundle -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <script>
            /*******************************************************
             * Helper: Parse "Topic" and "Message" from server data
             * Format: "Topic: my/topic | Message: {...}"
             *******************************************************/
            function parseTopicAndPayload(data) {
                const match = data.match(
                    /^Topic:\s+(.+?)\s+\|\s+Message:\s+(.*)$/,
                );
                if (match) {
                    return {
                        topic: match[1],
                        jsonString: match[2],
                    };
                }
                return { topic: null, jsonString: data };
            }

            /*******************************************************
             * Helper: Syntax highlight JSON
             *******************************************************/
            function syntaxHighlight(json) {
                if (typeof json !== "string") {
                    json = JSON.stringify(json, null, 2);
                }
                json = json
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");
                return json.replace(
                    /("(\\u[\da-fA-F]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|\b-?\d+(\.\d+)?\b)/g,
                    function (match) {
                        let cls = "number";
                        if (/^"/.test(match)) {
                            if (/:$/.test(match)) {
                                cls = "key";
                            } else {
                                cls = "string";
                            }
                        } else if (/true|false/.test(match)) {
                            cls = "boolean";
                        } else if (/null/.test(match)) {
                            cls = "null";
                        }
                        return '<span class="' + cls + '">' + match + "</span>";
                    },
                );
            }

            /*******************************************************
             * SSE Setup: Listen to /events for real-time messages
             *******************************************************/
            const eventSource = new EventSource("/events");
            const messagesDiv = document.getElementById("messages");

            eventSource.onmessage = function (e) {
                const { topic, jsonString } = parseTopicAndPayload(e.data);
                let displayedTopic = "";
                if (topic) {
                    displayedTopic = `<div class="topic-label">Topic: <span class="topic-name">${topic}</span></div>`;
                }

                let messageHTML = "";
                try {
                    const parsed = JSON.parse(jsonString);
                    messageHTML = syntaxHighlight(parsed);
                } catch (err) {
                    messageHTML = jsonString;
                }

                const time = new Date().toLocaleTimeString();
                const fullHTML = `
          <div class="message">
            <div class="timestamp">${time}</div>
            ${displayedTopic}
            <pre class="json-output">${messageHTML}</pre>
          </div>
        `;
                messagesDiv.innerHTML += fullHTML;
            };

            /*******************************************************
             * Connect / Disconnect Buttons
             *******************************************************/
            document
                .getElementById("connectBtn")
                .addEventListener("click", () => {
                    const data = {
                        brokerUrl: document.getElementById("brokerUrl").value,
                        brokerPort: document.getElementById("brokerPort").value,
                        topic: document.getElementById("topic").value,
                        username: document.getElementById("username").value,
                        password: document.getElementById("password").value,
                        qos: document.getElementById("qos").value,
                    };

                    fetch("/connect", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    })
                        .then((res) => res.json())
                        .then((json) => console.log("Connect:", json))
                        .catch((err) => console.error(err));
                });

            document
                .getElementById("disconnectBtn")
                .addEventListener("click", () => {
                    fetch("/disconnect", { method: "POST" })
                        .then((res) => res.json())
                        .then((json) => console.log("Disconnect:", json))
                        .catch((err) => console.error(err));
                });

            /*******************************************************
             * Clear, Download, and Copy Buttons
             *******************************************************/
            document
                .getElementById("clearBtn")
                .addEventListener("click", () => {
                    messagesDiv.innerHTML = "";
                });

            document
                .getElementById("downloadBtn")
                .addEventListener("click", () => {
                    const text = messagesDiv.innerText;
                    const blob = new Blob([text], { type: "text/plain" });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.href = url;
                    link.download = "mqtt_messages.txt";
                    link.click();
                    URL.revokeObjectURL(url);
                });

            document.getElementById("copyBtn").addEventListener("click", () => {
                const text = messagesDiv.innerText;
                navigator.clipboard
                    .writeText(text)
                    .then(() => console.log("Copied to clipboard"))
                    .catch((err) => console.error("Copy failed", err));
            });
        </script>
    </body>
</html>
