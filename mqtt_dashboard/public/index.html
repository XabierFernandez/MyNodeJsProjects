<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>MQTT Client Dashboard</title>

        <!-- Favicon -->
        <link
            rel="icon"
            href="/n3-favicon-kb-32x32px.svg"
            type="image/svg+xml"
        />

        <!-- Bootstrap CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/style.css" />
    </head>
    <body class="bg-light">
        <!-- Navbar with Logotype -->
        <nav class="navbar navbar-dark bg-dark">
            <div class="container-fluid">
                <a class="navbar-brand d-flex align-items-center" href="#">
                    <img
                        src="/Logotype-orange-n3uron.svg"
                        alt="Logotype"
                        class="me-3"
                        style="height: 40px"
                    />
                    <span style="font-size: 1.5rem">MQTT DASHBOARD</span>
                </a>
            </div>
        </nav>

        <!-- Main Container -->
        <div class="container-fluid px-4 py-4">
            <div class="row gx-5">
                <!-- Left Column: Connection Form -->
                <div class="col-12 col-sm-4 col-lg-3 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h4 class="card-title mb-3">MQTT Connection</h4>
                            <form>
                                <div class="mb-3">
                                    <label for="brokerUrl" class="form-label"
                                        >Broker URL</label
                                    >
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="brokerUrl"
                                        placeholder="e.g. datasim.n3uron.com"
                                        value="datasim.n3uron.com"
                                    />
                                </div>
                                <div class="mb-3">
                                    <label for="brokerPort" class="form-label"
                                        >Broker Port</label
                                    >
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="brokerPort"
                                        placeholder="e.g. 1883"
                                        value="1883"
                                    />
                                </div>
                                <div class="mb-3">
                                    <label for="topic" class="form-label"
                                        >Topic</label
                                    >
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="topic"
                                        placeholder="e.g. N3uron/#"
                                        value="N3uron/#"
                                    />
                                </div>
                                <div class="mb-3">
                                    <label for="username" class="form-label"
                                        >Username</label
                                    >
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="username"
                                        placeholder="Optional"
                                    />
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label"
                                        >Password</label
                                    >
                                    <input
                                        type="password"
                                        class="form-control"
                                        id="password"
                                        placeholder="Optional"
                                    />
                                </div>
                                <div class="mb-3">
                                    <label for="qos" class="form-label"
                                        >QoS</label
                                    >
                                    <select class="form-select" id="qos">
                                        <option value="0" selected>0</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                    </select>
                                </div>
                                <!-- MQTT Version Select -->
                                <div class="mb-3">
                                    <label for="mqttVersion" class="form-label"
                                        >MQTT Version</label
                                    >
                                    <select
                                        class="form-select"
                                        id="mqttVersion"
                                    >
                                        <option value="3.x" selected>
                                            3.x
                                        </option>
                                        <option value="5">5</option>
                                    </select>
                                </div>
                                <!-- TLS Toggle -->
                                <div class="form-check mb-3">
                                    <input
                                        type="checkbox"
                                        class="form-check-input"
                                        id="tlsToggle"
                                    />
                                    <label
                                        class="form-check-label"
                                        for="tlsToggle"
                                        >Enable TLS</label
                                    >
                                </div>
                                <!-- TLS Options -->
                                <div id="tlsOptions" style="display: none">
                                    <div class="mb-3">
                                        <label for="caCert" class="form-label"
                                            >CA Certificate</label
                                        >
                                        <input
                                            type="file"
                                            class="form-control"
                                            id="caCert"
                                        />
                                    </div>
                                    <div class="mb-3">
                                        <label
                                            for="clientCert"
                                            class="form-label"
                                            >Client Certificate</label
                                        >
                                        <input
                                            type="file"
                                            class="form-control"
                                            id="clientCert"
                                        />
                                    </div>
                                    <div class="mb-3">
                                        <label
                                            for="clientKey"
                                            class="form-label"
                                            >Client Key</label
                                        >
                                        <input
                                            type="file"
                                            class="form-control"
                                            id="clientKey"
                                        />
                                    </div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button
                                        type="button"
                                        id="connectBtn"
                                        class="btn btn-primary"
                                    >
                                        Connect
                                    </button>
                                    <button
                                        type="button"
                                        id="disconnectBtn"
                                        class="btn btn-secondary"
                                    >
                                        Disconnect
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Incoming Messages -->
                <div class="col-12 col-sm-8 col-lg-9">
                    <div class="card shadow-sm">
                        <div class="card-body d-flex flex-column">
                            <h4 class="card-title mb-3">
                                Incoming MQTT Messages
                            </h4>
                            <!-- Control Buttons -->
                            <div class="mb-3 d-flex gap-2 flex-wrap">
                                <button
                                    type="button"
                                    id="clearBtn"
                                    class="btn btn-warning"
                                >
                                    Clear Output
                                </button>
                                <button
                                    type="button"
                                    id="downloadBtn"
                                    class="btn btn-success"
                                >
                                    Download Output
                                </button>
                                <button
                                    type="button"
                                    id="copyBtn"
                                    class="btn btn-info"
                                >
                                    Copy to Clipboard
                                </button>
                            </div>
                            <!-- Notification Area -->
                            <div
                                id="notification"
                                class="mb-2 text-success"
                            ></div>
                            <!-- Messages Output Area -->
                            <div
                                id="messages"
                                class="message-output border rounded p-3 flex-grow-1"
                            ></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bootstrap JS Bundle -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <script>
            // Show/hide TLS options based on the TLS toggle
            document
                .getElementById("tlsToggle")
                .addEventListener("change", (e) => {
                    document.getElementById("tlsOptions").style.display = e
                        .target.checked
                        ? "block"
                        : "none";
                });

            // Helper function to read a file as text
            function readFileAsText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = () => reject(reader.error);
                    reader.readAsText(file);
                });
            }

            /*******************************************************
             * Helper: Parse "Topic", "Message", and optional "Props"
             * Expected format:
             * "Topic: my/topic | Message: {...}" or
             * "Topic: my/topic | Message: {...} | Props: {...}"
             *******************************************************/
            function parseTopicAndPayload(data) {
                // Use a regex that optionally captures properties.
                const match = data.match(
                    /^Topic:\s+(.+?)\s+\|\s+Message:\s+(.*?)(\s+\|\s+Props:\s+(.*))?$/,
                );
                if (match) {
                    return {
                        topic: match[1],
                        jsonString: match[2],
                        props: match[4] || "",
                    };
                }
                return { topic: null, jsonString: data, props: "" };
            }

            /*******************************************************
             * Helper: Syntax highlight JSON
             *******************************************************/
            function syntaxHighlight(json) {
                if (typeof json !== "string") {
                    json = JSON.stringify(json, null, 2);
                }
                json = json
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");
                return json.replace(
                    /("(\\u[\da-fA-F]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|\b-?\d+(\.\d+)?\b)/g,
                    function (match) {
                        let cls = "number";
                        if (/^"/.test(match)) {
                            cls = /:$/.test(match) ? "key" : "string";
                        } else if (/true|false/.test(match)) {
                            cls = "boolean";
                        } else if (/null/.test(match)) {
                            cls = "null";
                        }
                        return '<span class="' + cls + '">' + match + "</span>";
                    },
                );
            }

            /*******************************************************
             * SSE Setup: Listen to /events for real-time messages
             *******************************************************/
            const eventSource = new EventSource("/events");
            const messagesDiv = document.getElementById("messages");

            eventSource.onmessage = function (e) {
                const { topic, jsonString, props } = parseTopicAndPayload(
                    e.data,
                );
                let displayedTopic = "";
                if (topic) {
                    displayedTopic = `<div class="topic-label">Topic: <span class="topic-name">${topic}</span></div>`;
                }

                let messageHTML = "";
                try {
                    const parsed = JSON.parse(jsonString);
                    messageHTML = syntaxHighlight(parsed);
                } catch (err) {
                    messageHTML = jsonString;
                }

                let propsHTML = "";
                if (props) {
                    try {
                        const parsedProps = JSON.parse(props);
                        propsHTML = `<div class="props-label">Properties: <pre class="json-output">${syntaxHighlight(parsedProps)}</pre></div>`;
                    } catch (err) {
                        propsHTML = `<div class="props-label">Properties: ${props}</div>`;
                    }
                }

                const time = new Date().toLocaleTimeString();
                const fullHTML = `
                 <div class="message">
                   <div class="timestamp">${time}</div>
                   ${displayedTopic}
                   <pre class="json-output">${messageHTML}</pre>
                   ${propsHTML}
                 </div>
               `;
                messagesDiv.innerHTML += fullHTML;
            };

            /*******************************************************
             * Connect / Disconnect Buttons
             *******************************************************/
            document
                .getElementById("connectBtn")
                .addEventListener("click", async () => {
                    const data = {
                        brokerUrl: document.getElementById("brokerUrl").value,
                        brokerPort: document.getElementById("brokerPort").value,
                        topic: document.getElementById("topic").value,
                        username: document.getElementById("username").value,
                        password: document.getElementById("password").value,
                        qos: document.getElementById("qos").value,
                        tls: document.getElementById("tlsToggle").checked,
                        mqttVersion:
                            document.getElementById("mqttVersion").value,
                    };

                    if (data.tls) {
                        const caFile =
                            document.getElementById("caCert").files[0];
                        const certFile =
                            document.getElementById("clientCert").files[0];
                        const keyFile =
                            document.getElementById("clientKey").files[0];
                        data.ca = caFile ? await readFileAsText(caFile) : "";
                        data.cert = certFile
                            ? await readFileAsText(certFile)
                            : "";
                        data.key = keyFile ? await readFileAsText(keyFile) : "";
                    }

                    fetch("/connect", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    })
                        .then((res) => res.json())
                        .then((json) => console.log("Connect:", json))
                        .catch((err) => console.error(err));
                });

            document
                .getElementById("disconnectBtn")
                .addEventListener("click", () => {
                    fetch("/disconnect", { method: "POST" })
                        .then((res) => res.json())
                        .then((json) => console.log("Disconnect:", json))
                        .catch((err) => console.error(err));
                });

            /*******************************************************
             * Clear, Download, and Copy Buttons
             *******************************************************/
            document
                .getElementById("clearBtn")
                .addEventListener("click", () => {
                    messagesDiv.innerHTML = "";
                });

            document
                .getElementById("downloadBtn")
                .addEventListener("click", () => {
                    const text = messagesDiv.innerText;
                    const blob = new Blob([text], { type: "text/plain" });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.href = url;
                    link.download = "mqtt_messages.txt";
                    link.click();
                    URL.revokeObjectURL(url);
                });

            document.getElementById("copyBtn").addEventListener("click", () => {
                const text = messagesDiv.innerText;
                navigator.clipboard
                    .writeText(text)
                    .then(() => {
                        const notification =
                            document.getElementById("notification");
                        notification.textContent = "Copied to clipboard!";
                        setTimeout(() => {
                            notification.textContent = "";
                        }, 3000);
                    })
                    .catch((err) => console.error("Copy failed", err));
            });
        </script>
    </body>
</html>
